rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Grandpas collection - public read, authenticated write with validation
    match /grandpas/{grandpaId} {
      // Anyone can read grandpa profiles (for search)
      allow read: if true;
      
      // Only authenticated users can create grandpa profiles
      allow create: if request.auth != null 
        && isValidGrandpaData(request.resource.data)
        && request.resource.data.userId == request.auth.uid;
      
      // Only the owner can update their profile
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid
        && isValidGrandpaData(request.resource.data);
      
      // Only the owner can delete their profile
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
    
    // Apprentices collection - restricted read access, authenticated write with validation
    match /apprentices/{apprenticeId} {
      // Apprentice owners can always read their own profile
      // Grandpas can read apprentice profiles (needed for dashboard and requests)
      allow read: if request.auth != null 
        && (request.auth.uid == resource.data.userId
            || isGrandpaUser(request.auth.uid));
      
      // Only authenticated users can create apprentice profiles
      allow create: if request.auth != null 
        && isValidApprenticeData(request.resource.data)
        && request.resource.data.userId == request.auth.uid;
      
      // Only the owner can update their profile
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid
        && isValidApprenticeData(request.resource.data);
      
      // Only the owner can delete their profile
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
    
    // Requests collection - for help requests between apprentices and grandpas
    match /requests/{requestId} {
      // Only involved parties can read requests
      allow read: if request.auth != null 
        && (request.auth.uid == resource.data.apprenticeId 
            || request.auth.uid == resource.data.grandpaId);
      
      // Only authenticated apprentices can create requests
      allow create: if request.auth != null 
        && isValidRequestData(request.resource.data)
        && request.resource.data.apprenticeId == request.auth.uid;
      
      // Both apprentice and grandpa can update requests (for status changes and confirmations)
      allow update: if request.auth != null 
        && (request.auth.uid == resource.data.apprenticeId 
            || request.auth.uid == resource.data.grandpaId)
        && isValidRequestUpdate(request.resource.data, resource.data);
      
      // Only involved parties can delete requests
      allow delete: if request.auth != null 
        && (request.auth.uid == resource.data.apprenticeId 
            || request.auth.uid == resource.data.grandpaId);
    }
    
    // Messages collection - for future messaging feature
    match /messages/{messageId} {
      // Users can only read messages they're involved in
      allow read: if request.auth != null 
        && (request.auth.uid == resource.data.senderId 
            || request.auth.uid == resource.data.receiverId);
      
      // Users can create messages if they're the sender
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.senderId
        && isValidMessageData(request.resource.data);
    }
    
    // Admin-only collections
    match /admin/{document=**} {
      allow read, write: if request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Test collection (remove in production)
    match /test/{document} {
      allow read, write: if request.auth != null;
    }
  }
  
  // Validation functions
  function isValidGrandpaData(data) {
    return data.keys().hasAll(['name', 'address', 'phone', 'email', 'skills', 'note', 'timestamp', 'userId'])
      && data.name is string && data.name.size() > 0
      && data.address is string && data.address.size() > 0
      && data.phone is string && data.phone.size() > 0
      && data.email is string && data.email.matches('.*@.*')
      && data.skills is string && data.skills.size() > 0
      && data.note is string && data.note.size() > 0
      && data.timestamp is string
      && data.userId is string;
  }
  
  function isValidApprenticeData(data) {
    return data.keys().hasAll(['name', 'address', 'phone', 'email', 'timestamp', 'userId'])
      && data.name is string && data.name.size() > 0
      && data.address is string && data.address.size() > 0
      && data.phone is string && data.phone.size() > 0
      && data.email is string && data.email.matches('.*@.*')
      && data.timestamp is string
      && data.userId is string;
  }
  
  function isValidRequestData(data) {
    return data.keys().hasAll(['apprenticeId', 'grandpaId', 'subject', 'message', 'status', 'timestamp'])
      && data.apprenticeId is string && data.apprenticeId.size() > 0
      && data.grandpaId is string && data.grandpaId.size() > 0
      && data.subject is string && data.subject.size() > 0
      && data.message is string && data.message.size() > 0
      && data.status is string && data.status in ['pending', 'accepted', 'declined', 'confirmed']
      && data.timestamp is string;
  }
  
  function isValidRequestUpdate(newData, oldData) {
    // Grandpa can update status, response, and proposed time
    let grandpaCanUpdate = newData.keys().hasAny(['status', 'grandpaResponse', 'proposedTime', 'respondedAt', 'declinedAt']);
    
    // Apprentice can update confirmation fields
    let apprenticeCanUpdate = newData.keys().hasAny(['status', 'apprenticeConfirmation', 'confirmedAt']);
    
    return grandpaCanUpdate || apprenticeCanUpdate;
  }
  
  // Check if user is a grandpa (has role 'grandpa' in users collection)
  function isGrandpaUser(userId) {
    return get(/databases/$(database)/documents/users/$(userId)).data.role == 'grandpa';
  }
  
  function isValidMessageData(data) {
    return data.keys().hasAll(['senderId', 'receiverId', 'message', 'timestamp'])
      && data.senderId is string
      && data.receiverId is string
      && data.message is string && data.message.size() > 0
      && data.timestamp is string;
  }
}
